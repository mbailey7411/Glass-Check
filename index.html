<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV Processor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }
        .container {
            max-width: 800px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        input[type="file"], button {
            display: block;
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #45a049;
        }
        #output, #preview {
            margin-top: 20px;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            background-color: #fff;
        }
        #qrcode img {
            display: block;
            margin: 20px auto;
        }
        #shareLink {
            margin-top: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>CSV Processor</h1>
        <input type="file" id="fileInput" accept=".csv">
        <button id="downloadBtn" style="display: none;">Download Processed CSV</button>
        <button id="generateQRBtn" style="display: none;">Generate QR Code</button>
        <button id="emailUncheckedBtn" style="display: none;">Email Unchecked Items</button>
        <div id="output"></div>
        <div id="qrcode"></div>
        <div id="shareLink"></div>
        <div id="preview"></div>
    </div>

    <script>
        let processedCsv = null;
        let processedData = null;

        document.getElementById('fileInput').addEventListener('change', handleFileSelect);
        document.getElementById('downloadBtn').addEventListener('click', downloadCsv);
        document.getElementById('generateQRBtn').addEventListener('click', generateQRCode);
        document.getElementById('emailUncheckedBtn').addEventListener('click', emailUncheckedItems);

        function handleFileSelect(event) {
            const file = event.target.files[0];
            Papa.parse(file, {
                complete: function(results) {
                    processedData = processData(results.data);
                    processedCsv = Papa.unparse(processedData);
                    showPreview(processedData);
                    document.getElementById('downloadBtn').style.display = 'block';
                    document.getElementById('generateQRBtn').style.display = 'block';
                    document.getElementById('emailUncheckedBtn').style.display = 'block';
                    document.getElementById('output').innerHTML = 'CSV processed successfully!';
                }
            });
        }

        function processData(data) {
            // Remove empty rows
            data = data.filter(row => row.some(cell => cell.trim() !== ''));
            
            // Process part numbers
            return data.map(row => processParts(row));
        }

        function processParts(row) {
            return row.map(cell => {
                if (cell.includes('-')) {
                    const [prefix, suffix] = cell.split('-');
                    if (suffix && !isNaN(suffix)) {
                        return prefix + '-' + suffix.padStart(3, '0');
                    }
                }
                return cell;
            });
        }

        function showPreview(data) {
            const previewElement = document.getElementById('preview');
            let htmlContent = '<h3>Preview:</h3><table border="1"><tr>';
            
            // Add table headers
            data[0].forEach(header => {
                htmlContent += `<th>${header}</th>`;
            });
            htmlContent += '</tr>';
            
            // Add table rows
            data.slice(1, 6).forEach(row => {
                htmlContent += '<tr>';
                row.forEach(cell => {
                    htmlContent += `<td>${cell}</td>`;
                });
                htmlContent += '</tr>';
            });
            
            htmlContent += '</table>';
            if (data.length > 6) {
                htmlContent += '<p>... (showing first 5 rows)</p>';
            }
            
            previewElement.innerHTML = htmlContent;
        }

        function downloadCsv() {
            if (processedCsv) {
                const blob = new Blob([processedCsv], { type: 'text/csv;charset=utf-8;' });
                saveAs(blob, "processed.csv");
            }
        }

        function generateQRCode() {
            if (processedData) {
                try {
                    const jsonData = JSON.stringify(processedData);
                    const compressedData = LZString.compressToEncodedURIComponent(jsonData);
                    const shareUrl = `https://mbailey7411.github.io/mobile-checklist/savedata.html?data=${compressedData}`;
                    const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(shareUrl)}`;
                    
                    const qrcodeElement = document.getElementById("qrcode");
                    qrcodeElement.innerHTML = `<img src="${qrCodeUrl}" alt="QR Code">`;
                    
                    const shareLinkElement = document.getElementById('shareLink');
                    shareLinkElement.innerHTML = `<p>Or use this link: <a href="${shareUrl}" target="_blank">${shareUrl}</a></p>`;
                    shareLinkElement.style.display = 'block';
                    
                    document.getElementById('output').innerHTML = 'QR Code generated successfully. Scan it with a mobile device or use the provided link.';
                } catch (error) {
                    console.error("Error generating QR code:", error);
                    document.getElementById('output').innerHTML = 'Error generating QR code: ' + error.message;
                }
            } else {
                document.getElementById('output').innerHTML = 'No processed data available. Please upload and process a CSV file first.';
            }
        }

        function emailUncheckedItems() {
            if (processedData) {
                // Assume the first row is headers and should always be included
                let uncheckedData = [processedData[0]];
                
                // Add a checkbox column to the headers
                uncheckedData[0].unshift('Checked');
                
                // Add unchecked rows (assuming all items are initially unchecked)
                for (let i = 1; i < processedData.length; i++) {
                    let row = processedData[i];
                    row.unshift('[ ]'); // Add an empty checkbox to each row
                    uncheckedData.push(row);
                }
                
                const uncheckedCsv = Papa.unparse(uncheckedData);
                const blob = new Blob([uncheckedCsv], { type: 'text/csv;charset=utf-8;' });
                const csvUrl = URL.createObjectURL(blob);
                
                const subject = 'Unchecked Items CSV';
                const body = 'Please find attached the CSV file with unchecked items.';
                
                const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}&attachment=${csvUrl}`;
                
                window.location.href = mailtoLink;
                
                document.getElementById('output').innerHTML = 'Email client opened with unchecked items CSV attached.';
            } else {
                document.getElementById('output').innerHTML = 'No processed data available. Please upload and process a CSV file first.';
            }
        }
    </script>
</body>
</html>
