<!DOCTYPE html>
<html lang="en">
<!-- ... (previous head and body content remains the same) ... -->

<script>
    // ... (previous functions remain the same) ...

    function generateQRCode() {
        console.log("generateQRCode function called");
        if (processedData) {
            try {
                console.log("Processed data available:", processedData);
                
                // Convert the processed data to a JSON string
                const jsonData = JSON.stringify(processedData);
                console.log("JSON data length:", jsonData.length);
                
                // Encode the JSON string using encodeURIComponent
                const encodedData = encodeURIComponent(jsonData);
                console.log("Encoded data length:", encodedData.length);
                
                // Create the share URL with the encoded data
                const shareUrl = `https://mbailey7411.github.io/mobile-checklist/?data=${encodedData}`;
                console.log("Share URL length:", shareUrl.length);
                
                // Generate QR code using qrcode-generator library
                const qr = qrcode(0, 'L');
                qr.addData(shareUrl);
                qr.make();
                const qrCodeImg = qr.createImgTag(5);
                
                // Display QR code
                const qrcodeElement = document.getElementById("qrcode");
                if (!qrcodeElement) {
                    throw new Error("QR code element not found");
                }
                qrcodeElement.innerHTML = qrCodeImg;
                
                // Display share link
                const shareLinkElement = document.getElementById('shareLink');
                if (shareLinkElement) {
                    shareLinkElement.innerHTML = `<p>Or use this link: <a href="${shareUrl}" target="_blank">${shareUrl}</a></p>`;
                    shareLinkElement.style.display = 'block';
                } else {
                    console.warn("Share link element not found");
                }
                
                document.getElementById('output').innerHTML = 'QR Code generated successfully. Scan it with a mobile device or use the provided link.';
            } catch (error) {
                console.error("Error generating QR code:", error);
                document.getElementById('output').innerHTML = 'Error generating QR code: ' + error.message;
            }
        } else {
            console.log("No processed data available");
            document.getElementById('output').innerHTML = 'No processed data available. Please upload and process a CSV file first.';
        }
    }

    // ... (rest of the script remains the same) ...

    // Update the mobile checklist page handler
    if (window.location.href.includes('mobile-checklist')) {
        const urlParams = new URLSearchParams(window.location.search);
        const encodedData = urlParams.get('data');
        if (encodedData) {
            const jsonData = decodeURIComponent(encodedData);
            processedData = JSON.parse(jsonData);
            showPreview(processedData);
        }
    }
</script>
</body>
</html>
